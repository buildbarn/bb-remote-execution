syntax = "proto3";

package buildbarn.remoteactionrouter;

import "build/bazel/remote/execution/v2/remote_execution.proto";
import "google/protobuf/any.proto";

option go_package = "github.com/buildbarn/bb-remote-execution/pkg/proto/remoteactionrouter";

message RouteActionRequest {
  // The REv2 instance name prefix to operate against.
  string instance_name_prefix = 1;

  build.bazel.remote.execution.v2.DigestFunction.Value digest_function = 2;

  build.bazel.remote.execution.v2.Action action = 3;

  build.bazel.remote.execution.v2.RequestMetadata request_metadata = 4;
}

message RouteActionResponse {
  // The updated action.
  build.bazel.remote.execution.v2.Action action = 1;

  // Invocation keys used for fairness grouping, the first key in the array is most coarse while the last one is most granular.
  repeated google.protobuf.Any invocation_keys = 4;
}

// To make action routing more pluggable bb_scheduler will call into this
// service allowing it to update the Action and decide the scheduler queue
// and fairness policy to use.
service ActionRouter {
  rpc RouteAction(RouteActionRequest) returns (RouteActionResponse);
}
